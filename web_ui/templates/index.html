<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GLE Parser - Visualizer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body class="bg-gradient-to-br from-gray-900 via-gray-800 to-black min-h-screen p-6">
  <div class="max-w-6xl mx-auto">
    <div class="backdrop-blur-md bg-white/5 border border-white/10 rounded-2xl p-8 shadow-xl">
      <div class="flex items-center justify-between mb-6">
        <h1 class="text-3xl text-white font-semibold">âš™ï¸ GLE Parser â€” Visualizer</h1>
        <div class="text-sm text-gray-300">D3 AST visualization â€¢ Global / Local / Expression</div>
      </div>

      <form method="POST" enctype="multipart/form-data" class="space-y-6">
        <label id="fileLabel" 
               class="flex items-center justify-between gap-4 px-4 py-3 bg-white/5 text-white rounded-lg border border-dashed border-white/10 cursor-pointer hover:bg-white/6 transition">
          <div>
            <div id="fileText" class="text-lg">ğŸ“ Click to Upload Code File</div>
            <div id="fileSub" class="text-xs text-gray-300">Supported: .c, .cpp, .js, .java, .py (plain text)</div>
          </div>
          <input id="fileInput" type="file" name="codefile" class="hidden" required onchange="previewFile(event)">
        </label>

        <div id="previewContainer" class="hidden">
          <h3 class="text-white font-medium">ğŸ“„ File Preview</h3>
          <pre id="fileContent" class="mt-2 bg-black/60 text-gray-200 p-4 rounded-md max-h-48 overflow-auto whitespace-pre-wrap"></pre>
        </div>

        <div class="flex gap-4">
          <button type="submit" class="flex-1 py-3 rounded-lg bg-gradient-to-r from-blue-600 to-purple-600 text-white font-semibold shadow hover:scale-[1.01] transition">
            ğŸ” Run Parser
          </button>
          <button type="button" onclick="clearPreview()" class="py-3 px-4 rounded-lg border border-white/10 text-white/80">Clear Preview</button>
        </div>
      </form>

      {% if result %}
        <div class="mt-6">
          <h3 class="text-white font-semibold">Result</h3>
          <pre class="mt-2 bg-black/60 text-green-300 p-4 rounded-md max-h-40 overflow-auto whitespace-pre-wrap">{{ result }}</pre>
        </div>
      {% endif %}

      <div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div>
          <h3 class="text-white font-semibold">ğŸ“Œ Scope & Expression Visualization</h3>
          <div id="treeContainer" class="mt-3 bg-black/40 border border-white/10 rounded-md h-96 overflow-hidden"></div>
        </div>

        <div>
          <h3 class="text-white font-semibold">ğŸ” Tokens / Summary</h3>
          <div id="summary" class="mt-3 bg-black/40 border border-white/10 rounded-md h-96 p-4 overflow-auto text-gray-200"></div>
        </div>
      </div>
    </div>
  </div>

<script>
/* -------------- File preview (client side) -------------- */
function previewFile(event) {
    const file = event.target.files[0];
    if (!file) return;
    document.getElementById("fileText").textContent = "ğŸ“„ " + file.name;

    const reader = new FileReader();
    reader.onload = function(e) {
        const content = e.target.result;
        document.getElementById("fileContent").textContent = content;
        document.getElementById("previewContainer").classList.remove("hidden");

        // persist preview across reloads
        localStorage.setItem("uploadedFilename", file.name);
        localStorage.setItem("uploadedContent", content);
    };
    reader.readAsText(file);
}

function clearPreview() {
    localStorage.removeItem("uploadedFilename");
    localStorage.removeItem("uploadedContent");
    document.getElementById("fileContent").textContent = "";
    document.getElementById("fileText").textContent = "ğŸ“ Click to Upload Code File";
    document.getElementById("previewContainer").classList.add("hidden");
}

// restore preview on load
window.addEventListener('DOMContentLoaded', () => {
    const savedName = localStorage.getItem("uploadedFilename");
    const savedContent = localStorage.getItem("uploadedContent");
    if (savedName && savedContent) {
        document.getElementById("fileText").textContent = "ğŸ“„ " + savedName;
        document.getElementById("fileContent").textContent = savedContent;
        document.getElementById("previewContainer").classList.remove("hidden");
    }
});
</script>
<script>
// ===================== D3 AST TREE ======================
function drawTree(ast) {
    const container = document.getElementById("treeContainer");
    container.innerHTML = "";

    const width = container.clientWidth;
    const height = container.clientHeight;

    // Create SVG canvas
    const svg = d3.select(container)
        .append("svg")
        .attr("width", width)
        .attr("height", height);

    // Main group that will scale + move
    const g = svg.append("g").attr("transform", "translate(50, 50)");

    // ---- Enable Zoom + Pan ----
    const zoom = d3.zoom()
        .scaleExtent([0.4, 2])
        .on("zoom", (event) => {
            g.attr("transform", event.transform);
        });

    svg.call(zoom);

    // ================= AST â†’ D3 Hierarchy =================
    function astToHierarchy(ast) {
        const root = { name: "Program", children: [] };

        if (ast.globals?.length) {
            root.children.push({
                name: "Globals",
                children: ast.globals.map(g => ({
                    name: `${g.type} ${g.name}`,
                    raw: g
                }))
            });
        }

        if (ast.functions?.length) {
            root.children.push({
                name: "Functions",
                children: ast.functions.map(f => ({
                    name: `fn: ${f.name}`,
                    raw: f,
                    children: [
                        f.params?.length ? {
                            name: "Params",
                            children: f.params.map(p => ({
                                name: `${p.type} ${p.name}`,
                                raw: p
                            }))
                        } : null,
                        f.locals?.length ? {
                            name: "Locals",
                            children: f.locals.map(l => ({
                                name: `${l.type} ${l.name}`,
                                raw: l
                            }))
                        } : null,
                        f.expressions?.length ? {
                            name: "Expressions",
                            children: f.expressions.map(e => ({
                                name: e.text,
                                raw: e
                            }))
                        } : null
                    ].filter(Boolean)
                }))
            });
        }

        return root;
    }

    const root = d3.hierarchy(astToHierarchy(ast));

    const treeLayout = d3.tree().size([width - 150, height - 150]);
    treeLayout(root);

    // ================= Draw Links =================
    g.selectAll(".link")
        .data(root.links())
        .enter()
        .append("path")
        .attr("class", "link")
        .attr("fill", "none")
        .attr("stroke", "#6b7280")
        .attr("stroke-width", 1.3)
        .attr("d", d3.linkVertical()
            .x(d => d.x)
            .y(d => d.y)
        );

    // ================= Draw Nodes =================
    const node = g.selectAll(".node")
        .data(root.descendants())
        .enter()
        .append("g")
        .attr("class", "node")
        .attr("transform", d => `translate(${d.x}, ${d.y})`)
        .on("dblclick", (event, d) => {
            // Collapse / Expand Node
            if (d.children) {
                d._children = d.children;
                d.children = null;
            } else {
                d.children = d._children;
                d._children = null;
            }
            drawTree(ast);
        });

    // ---- Node Circle (with heatmap coloring) ----
    node.append("circle")
        .attr("r", 18)
        .attr("fill", d => {
            // Expression heat map coloring
            if (d.data.raw?.text) {
                const depth = (d.data.raw.text.match(/\(/g) || []).length;
                return d3.interpolateTurbo(Math.min(depth / 5, 1));
            }

            // Category fallback colors
            const n = d.data.name;
            if (n.startsWith("fn:")) return "#9333ea";
            if (n === "Globals") return "#3b82f6";
            if (n === "Params") return "#22c55e";
            if (n === "Locals") return "#f59e0b";
            if (n === "Expressions") return "#ef4444";
            return "#94a3b8";
        })
        .style("filter", "drop-shadow(0 0 6px rgba(255,255,255,0.35))")
        .attr("stroke", "#111")
        .attr("stroke-width", 2)
        .on("click", (event, d) => {
            // Highlight code line
            const raw = d.data.raw;
            if (!raw || !raw.lineno) return;

            const contentElem = document.getElementById("fileContent");
            const lines = contentElem.textContent.split("\n");

            const highlighted = lines.map((l, idx) =>
                idx + 1 === raw.lineno
                    ? `ğŸ‘‰  ${l}`
                    : `    ${l}`
            );

            contentElem.textContent = highlighted.join("\n");

            // Show metadata in summary panel
            const summary = document.getElementById("summary");
            summary.innerHTML =
                `<strong>${d.data.name}</strong>` +
                `<pre>${JSON.stringify(d.data.raw, null, 2)}</pre>`;
        });

    // ================= Wrapped Labels =================
    node.append("text")
        .attr("dy", 4)
        .attr("text-anchor", "middle")
        .style("font-size", "10px")
        .style("fill", "#fff")
        .each(function (d) {
            const text = d3.select(this);
            const name = d.data.name || "";
            const maxChars = 12;

            const parts = name.match(new RegExp('.{1,' + maxChars + '}', 'g')) || [name];

            parts.forEach((line, i) => {
                text.append("tspan")
                    .attr("x", 0)
                    .attr("dy", i === 0 ? 0 : 10)
                    .text(line);
            });
        });
}
</script>


<!-- Server will emit AST into localStorage and call drawTree when present -->
{% if ast %}
<script>
    try {
        const astObj = {{ ast|safe }};
        localStorage.setItem("gle_AST", JSON.stringify(astObj));
        // draw immediately
        drawTree(astObj);
        document.getElementById("summary").innerHTML = `<pre>${JSON.stringify(astObj, null, 2)}</pre>`;
    } catch (e) {
        console.error("Failed to load AST from server:", e);
    }
</script>
{% endif %}

</body>
</html>
